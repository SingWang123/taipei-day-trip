<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Index</title>
  <link href="styles/style.css" rel="stylesheet" type="text/css">
</head>

<body class = "body">
  <!--navigation bar-->
  <div class = "navbar">
    <div class = "navbar__content">
      <div class = "navbar__webtitle">
        台北一日遊
      </div>
      <div class = "navbar__buttons">
        <div class = "navbar__buttons_button">
          預定行程
        </div>
        <div class = "navbar__buttons_button">
          登入/註冊
        </div>
      </div>
    </div>
  </div>
  <!--banner-->
  <div class = "banner">
    <div class = "banner__content">
      <div class = "banner__content_title">
        輕鬆享受台北一日悠閒
      </div>
      <div class = "banner__content_info">
        探索每個角落，體驗城市的深度旅遊行程
      </div>
      <div class = "banner__content_search">
          <input placeholder = "輸入景點名稱查詢" class = "banner__search_input" id = "search_input">
          <div class = "banner__search_button" id = "search_button">
            <img src = "images/search.png" class = "banner__search_button_img">
          </div>
      </div>
    </div>
  </div>
  <!--mrts-->
  <div class = "mrts">
    <div class = "mrts__button--left"></div>
    <div class = "mrts__list">
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
      <div class = "mrts__list_mrt">
        台北車站
      </div>
    </div>
    <div class = "mrts__button--right"></div>
  </div>
  <!--main-->
  <div class = "main">
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img" >
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img" >
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img" >
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img" >
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
    <div class = "main__card">
      <img class = "main__card_img">
      <div class = "main__card_name">
        平安鐘
      </div>
      <div class = "main__card_buttom">
        <div class = "main__card_mrt">忠孝復興</div>
        <div class = "main__card_category">忠孝復興</div>
      </div>
    </div>
  </div>

  <footer class = "footer">
    <div class = "footer__word">
      COPYRIGHT © 2021 台北一日遊
    </div>
  </footer>
</body>

<script>

//紀錄目前頁面和資料的最大頁面
var page = 0;
var maxpage = "";  


//創建景點卡片的函式
function createAttraction(){
  let mainList = document.getElementsByClassName("main");

  let mainCard = document.createElement("div");
  mainCard.className = "main__card";

  let mainCardImg = document.createElement("img");
  mainCardImg.className = "main__card_img";

  let mainCardName = document.createElement("div");
  mainCardName.className = "main__card_name";

  let mainCardButtom = document.createElement("div");
  mainCardButtom.className = "main__card_buttom";

  let mainCardMrt = document.createElement("div");
  mainCardMrt.className = "main__card_mrt";

  let mainCardCategory = document.createElement("div");
  mainCardCategory.className = "main__card_category";

  //開始組裝
  mainCardButtom.appendChild(mainCardMrt);
  mainCardButtom.appendChild(mainCardCategory);
  mainCard.appendChild(mainCardImg);
  mainCard.appendChild(mainCardName);
  mainCard.appendChild(mainCardButtom);

  mainList[0].appendChild(mainCard);
}


// 首頁開啟時的api，塞page=0的資料
fetch("http://54.168.177.59:8000/api/attractions?page=0")
.then(function(response){
  return response.json();
})
.then(function(data){
  let attractionData = [];
  for (i = 0; i < data.data.length; i++){
    attractionData.push({
      "name" : data.data[i].name,
      "mrt" : data.data[i].mrt,
      "category" : data.data[i].category,
      "img" : data.data[i].images[0]
    })
  }
  // 將景點資料塞進去Html中
  for (i = 0; i < attractionData.length; i++){
  
    let mainCardImg = document.getElementsByClassName("main__card_img");
    mainCardImg[i].src = attractionData[i].img;

    let mainCardName = document.getElementsByClassName("main__card_name");
    mainCardName[i].textContent = attractionData[i].name;

    let mainCardMrt = document.getElementsByClassName("main__card_mrt");
    mainCardMrt[i].textContent = attractionData[i].mrt;

    let mainCardCategory = document.getElementsByClassName("main__card_category");
    mainCardCategory[i].textContent = attractionData[i].category
  }

  if (data.nextPage != null ){  //檢查確認是否有下一頁，有的話page+1 
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
  }
})


//往下拉，產出下一頁的圖片的函式
function creatNextPage(){
  //檢查搜尋框有沒有參數，有的話fetch的位址要加上keyword
  let keyword = document.getElementById("search_input");
  if (page == maxpage){
    return; //page = maxpage 表示目前是最後一頁，再往下拉也載不到資料
  } if (keyword.value == ""){
    url = "http://54.168.177.59:8000/api/attractions?page=" + page ;
  } else {
    url = "http://54.168.177.59:8000/api/attractions?page=" + page + "&keyword=" + keyword.value ;
  }

  fetch(url)
  .then(function(response){
    return response.json();
  })
  .then(function(data){
    let attractionData = []
    for (i = 0; i < data.data.length; i++){
      attractionData.push({
        "name" : data.data[i].name,
        "mrt" : data.data[i].mrt,
        "category" : data.data[i].category,
        "img" : data.data[i].images[0]
      })
    }
    //(i = page * 12 ; i < attractionData.length + page * 12; i++)
    console.log(attractionData);
    for (i = 0 ; i < attractionData.length; i++){
      createAttraction();
      
      let mainCardImg = document.getElementsByClassName("main__card_img");
      mainCardImg[page * 12 + i].src = attractionData[i].img;

      let mainCardName = document.getElementsByClassName("main__card_name");
      mainCardName[page * 12 + i].textContent = attractionData[i].name;

      let mainCardMrt = document.getElementsByClassName("main__card_mrt");
      mainCardMrt[page * 12 + i].textContent = attractionData[i].mrt;

      let mainCardCategory = document.getElementsByClassName("main__card_category");
      mainCardCategory[page * 12 + i].textContent = attractionData[i].category
    }
    
    if (data.nextPage != null ){
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
    }

  })
}


// IntersectionObserverEntry，畫面拖到footer會觸發載入新景點資料的函式
// 定義觸發的門檻值
const option = {
  threshold: [0.5]
};

//觀察的元素，isIntersecting（boolean）：常用屬性，判斷元素是否進入窗口範圍。
const callback = (entries, observe) => {
  if (entries[0].isIntersecting){
    creatNextPage()
  }
};

const observer = new IntersectionObserver(callback, option);
observer.observe(document.querySelector(".footer"));



//搜尋資料的函式
function searchAttraction(){
  //檢查搜尋框有沒有參數，有的話fetch的位址要加上keyword
  let keyword = document.getElementById("search_input");
  page = 0; //搜尋點下去後，page會歸0，maxpage的資料也清空
  maxpage = "" ; 
  
  let items = document.getElementsByClassName("main__card") ;//點下搜尋後，計算目前有多少物件
  console.log(items.length);

  if (keyword.value == ""){
    url = "http://54.168.177.59:8000/api/attractions?page=" + page ;
  } else {
    url = "http://54.168.177.59:8000/api/attractions?page=" + page + "&keyword=" + keyword.value ;
  }

  fetch(url)
  .then(function(response){
    return response.json();
  })
  .then(function(data){
    let attractionData = [];
    for (i = 0; i < data.data.length; i++){
      attractionData.push({
        "name" : data.data[i].name,
        "mrt" : data.data[i].mrt,
        "category" : data.data[i].category,
        "img" : data.data[i].images[0]
      })
    }
 
    console.log(attractionData.length);
     
    //被多砍掉的要新建 可能要比對現有資料的長度，做各種處理
    if (items.length <= attractionData.length){
      for (i = 0 ; i < attractionData.length; i++){
        if (i < items.length){
          let mainCardImg = document.getElementsByClassName("main__card_img");
          mainCardImg[i].src = attractionData[i].img;

          let mainCardName = document.getElementsByClassName("main__card_name");
          mainCardName[i].textContent = attractionData[i].name;

          let mainCardMrt = document.getElementsByClassName("main__card_mrt");
          mainCardMrt[i].textContent = attractionData[i].mrt;

          let mainCardCategory = document.getElementsByClassName("main__card_category");
          mainCardCategory[i].textContent = attractionData[i].category

        } if ( items.length <= i && i< attractionData.length) {
          createAttraction();
        
          let mainCardImg = document.getElementsByClassName("main__card_img");
          mainCardImg[i].src = attractionData[i].img;

          let mainCardName = document.getElementsByClassName("main__card_name");
          mainCardName[i].textContent = attractionData[i].name;

          let mainCardMrt = document.getElementsByClassName("main__card_mrt");
          mainCardMrt[i].textContent = attractionData[i].mrt;

          let mainCardCategory = document.getElementsByClassName("main__card_category");
          mainCardCategory[i].textContent = attractionData[i].category
        }
      }
    }
    let exist_items = items.length; //先記下目前畫面上的物件數量，不然for迴圈砍物件時，數量會一直減少，跑不到目標數值

    if (items.length > attractionData.length){
      for (i = 0 ; i < exist_items; i++){
        if (i < attractionData.length){
          let mainCardImg = document.getElementsByClassName("main__card_img");
          mainCardImg[i].src = attractionData[i].img;

          let mainCardName = document.getElementsByClassName("main__card_name");
          mainCardName[i].textContent = attractionData[i].name;

          let mainCardMrt = document.getElementsByClassName("main__card_mrt");
          mainCardMrt[i].textContent = attractionData[i].mrt;

          let mainCardCategory = document.getElementsByClassName("main__card_category");
          mainCardCategory[i].textContent = attractionData[i].category

        } else if ( attractionData.length <= i && i < exist_items) {
          let mainList = document.getElementsByClassName("main");
          let mainCard = document.getElementsByClassName("main__card");
          if (mainCard[attractionData.length]){
          mainList[0].removeChild(mainCard[attractionData.length]);
          }
        }
      }
    }

    if (data.nextPage != null ){
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
    }
  })
}



// 輸入景點位置點搜尋按鈕，執行 creatNextPage 函式
document.getElementById('search_button').addEventListener('click', function() {
  searchAttraction();
  })


</script>
</html>