<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Index</title>
  <!--AWS用
  <link href="/static/styles/style.css" rel="stylesheet" type="text/css">
   -->
  <!--本地端測試用 -->
  <link href="styles/style.css" rel="stylesheet" type="text/css"> 
  
</head>

<body class = "body">
  <!--signin -->
  <div class = "signin">
    <div class = "signin__window"> 
      <div class = "signin__window_top"></div>
      <div class = "signin__window_content">
          <div class = "signin__content_headline">登入會員帳號</div>
          <input class = "signin__input_email" placeholder = "輸入電子信箱">
          <input class = "signin__input_email" placeholder = "輸入密碼">
          <div class = "signin__button_signin">登入帳戶</div>
          <div class = "signin__button_signup">還沒有帳號？點此註冊</div>          
      </div>
      <div class = "signin__window_close"></div>
    </div>
  </div>
  <!--navigation bar-->
  <div class = "navbar">
    <div class = "navbar__content">
      <div class = "navbar__webtitle">
        台北一日遊
      </div>
      <div class = "navbar__buttons">
        <div class = "navbar__buttons_button">
          預定行程
        </div>
        <div class = "navbar__buttons_button">
          登入/註冊
        </div>
      </div>
    </div>
  </div>

  <!--banner-->
  <div class = "banner">
    <div class = "banner__content">
      <div class = "banner__content_title">
        輕鬆享受台北一日悠閒
      </div>
      <div class = "banner__content_info">
        探索每個角落，體驗城市的深度旅遊行程
      </div>
      <div class = "banner__content_search">
          <input placeholder = "輸入景點名稱查詢" class = "banner__search_input" id = "search_input">
          <div class = "banner__search_button" id = "search_button">
            <img src = "/static/images/search.png" class = "banner__search_button_img">
          </div>
      </div>
    </div>
  </div>
  <!--mrts-->
  <div class = "mrts">
    <div class = "mrts__button--left" id = "left_button"></div>
    <div class = "mrts__list">
      <!--由js生成，留一組做參考
      <div class = "mrts__list_mrt">
        劍潭
      </div>
      -->
    </div>
    <div class = "mrts__button--right" id = "right_button"></div>
  </div>
  <!--main-->
  
  <div class = "main">
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
    <a class = "main__card_url">
      <div class = "main__card">
        <img class = "main__card_img">
        <div class = "main__card_name">
          平安鐘
        </div>
        <div class = "main__card_buttom">
          <div class = "main__card_mrt">忠孝復興</div>
          <div class = "main__card_category">忠孝復興</div>
        </div>
      </div>
    </a>
  </div>

  <footer class = "footer">
    <div class = "footer__word">
      COPYRIGHT © 2021 台北一日遊
    </div>
  </footer>
</body>

<script>

//紀錄目前頁面和資料的最大頁面
var page = 0;
var maxpage = "";  


//創建景點卡片的函式
function createAttraction(){
  let mainList = document.getElementsByClassName("main");

  let mainCardUrl = document.createElement("a");
  mainCardUrl.className = "main__card_url"

  let mainCard = document.createElement("div");
  mainCard.className = "main__card";

  let mainCardImg = document.createElement("img");
  mainCardImg.className = "main__card_img";

  let mainCardName = document.createElement("div");
  mainCardName.className = "main__card_name";

  let mainCardButtom = document.createElement("div");
  mainCardButtom.className = "main__card_buttom";

  let mainCardMrt = document.createElement("div");
  mainCardMrt.className = "main__card_mrt";

  let mainCardCategory = document.createElement("div");
  mainCardCategory.className = "main__card_category";

  //開始組裝
  mainCardButtom.appendChild(mainCardMrt);
  mainCardButtom.appendChild(mainCardCategory);
  mainCard.appendChild(mainCardImg);
  mainCard.appendChild(mainCardName);
  mainCard.appendChild(mainCardButtom);
  mainCardUrl.appendChild(mainCard);

  mainList[0].appendChild(mainCardUrl);
}

//填入「最前面12筆的」卡片資料的函式
function enterData(i,attractionData){
  let mainCardUrl = document.getElementsByClassName("main__card_url");
  mainCardUrl[i].href = "http://54.168.177.59:8000/attraction/" + attractionData[i].id;

  let mainCardImg = document.getElementsByClassName("main__card_img");
  mainCardImg[i].src = attractionData[i].img;

  let mainCardName = document.getElementsByClassName("main__card_name");
  mainCardName[i].textContent = attractionData[i].name;

  let mainCardMrt = document.getElementsByClassName("main__card_mrt");
  mainCardMrt[i].textContent = attractionData[i].mrt;

  let mainCardCategory = document.getElementsByClassName("main__card_category");
  mainCardCategory[i].textContent = attractionData[i].category
}



// 2-2 首頁開啟時的api，塞page=0的資料
fetch("http://54.168.177.59:8000/api/attractions?page=0")
.then(function(response){
  return response.json();
})
.then(function(data){
  let attractionData = [];
  for (i = 0; i < data.data.length; i++){
    attractionData.push({
      "id" : data.data[i].id,
      "name" : data.data[i].name,
      "mrt" : data.data[i].mrt,
      "category" : data.data[i].category,
      "img" : data.data[i].images[0]
    })
  }
  // 將景點資料塞進去Html中
  for (i = 0; i < attractionData.length; i++){
    enterData(i,attractionData);
  }

  if (data.nextPage != null ){  //檢查確認是否有下一頁，有的話page+1 
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
  }
})


// 2-3 往下拉，讀取下一頁資料並產出景點卡片的函式
function creatNextPage(){
  //檢查搜尋框有沒有參數，有的話fetch的位址要加上keyword
  let keyword = document.getElementById("search_input");
  if (page === maxpage){
    return; //page = maxpage 表示目前是最後一頁，再往下拉也載不到資料
  } if (keyword.value == ""){
    url = "http://54.168.177.59:8000/api/attractions?page=" + page ;
  } else {
    url = "http://54.168.177.59:8000/api/attractions?page=" + page + "&keyword=" + keyword.value ;
  }

  fetch(url)
  .then(function(response){
    return response.json();
  })
  .then(function(data){
    let attractionData = []
    for (i = 0; i < data.data.length; i++){
      attractionData.push({
        "id" : data.data[i].id,
        "name" : data.data[i].name,
        "mrt" : data.data[i].mrt,
        "category" : data.data[i].category,
        "img" : data.data[i].images[0]
      })
    }
    
    for (i = 0 ; i < attractionData.length; i++){
      createAttraction();

      let mainCardUrl = document.getElementsByClassName("main__card_url");
      mainCardUrl[page * 12 + i].href = "http://54.168.177.59:8000/attraction/" + attractionData[i].id;

      let mainCardImg = document.getElementsByClassName("main__card_img");
      mainCardImg[page * 12 + i].src = attractionData[i].img;

      let mainCardName = document.getElementsByClassName("main__card_name");
      mainCardName[page * 12 + i].textContent = attractionData[i].name;

      let mainCardMrt = document.getElementsByClassName("main__card_mrt");
      mainCardMrt[page * 12 + i].textContent = attractionData[i].mrt;

      let mainCardCategory = document.getElementsByClassName("main__card_category");
      mainCardCategory[page * 12 + i].textContent = attractionData[i].category
    }
    
    if (data.nextPage != null ){
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
    }

  })
}


// IntersectionObserverEntry，畫面拖到footer會觸發載入新景點資料的函式
// 定義觸發的門檻值
const option = {
  threshold: [0.5]
};

//觀察的元素，isIntersecting（boolean）：常用屬性，判斷元素是否進入窗口範圍。
const callback = (entries, observe) => {
  if (entries[0].isIntersecting){
    creatNextPage() //當元素進入窗口範圍時，執行的函式
  }
};

const observer = new IntersectionObserver(callback, option);
observer.observe(document.querySelector(".footer"));  //觀察的元素設定為footer



// 2-4 搜尋關鍵字的函式
function searchAttraction(){
  //檢查搜尋框有沒有參數，有的話fetch的位址要加上keyword
  let keyword = document.getElementById("search_input");
  page = 0; //搜尋點下去後，page會歸0，maxpage的資料也清空
  maxpage = 0 ; 
  
  let items = document.getElementsByClassName("main__card") ;//點下搜尋後，計算目前有多少物件

  if (keyword.value == ""){
    url = "http://54.168.177.59:8000/api/attractions?page=" + page ;
  } else {
    url = "http://54.168.177.59:8000/api/attractions?page=" + page + "&keyword=" + keyword.value ;
  }

  fetch(url)
  .then(function(response){
    return response.json();
  })
  .then(function(data){
    if (data.error == true){
      alert("查無資料，請重新輸入關鍵字");
      return; //發生錯誤，後面的程式停止執行
    }
    
    let attractionData = [];
    for (i = 0; i < data.data.length; i++){
      attractionData.push({
        "id" : data.data[i].id,
        "name" : data.data[i].name,
        "mrt" : data.data[i].mrt,
        "category" : data.data[i].category,
        "img" : data.data[i].images[0]
      })
    }
     
    //被多砍掉的要新建 比對現有資料的長度，做各種處理
    if (items.length <= attractionData.length){ //目前畫面卡片比撈出來的資料少，需要新建卡片
      for (i = 0 ; i < attractionData.length; i++){
        if (i < items.length){
          enterData(i,attractionData);

        } if ( items.length <= i && i< attractionData.length) {
          createAttraction();
          enterData(i,attractionData);      
        }
      }
    }

    let exist_items = items.length; //先記下目前畫面上的物件數量，不然for迴圈砍物件時，數量會一直減少，跑不到目標數值

    if (items.length > attractionData.length){ //目前畫面卡片比資料多，需要砍掉卡片
      for (i = 0 ; i < exist_items; i++){
        if (i < attractionData.length){
          enterData(i,attractionData);

        } else if ( attractionData.length <= i && i < exist_items) {
          let mainList = document.getElementsByClassName("main");
          let mainCardUrl = document.getElementsByClassName("main__card_url");
          mainList[0].removeChild(mainCardUrl[attractionData.length]);
        }
      }
    }

    if (data.nextPage != null ){
      page += 1;
    } else {
      maxpage = page; //表示目前頁數已經到了最大值
    }
  })
}


// 輸入景點位置點搜尋按鈕，執行searchAttraction 搜尋景點的函式
document.getElementById('search_button').addEventListener('click', function() {
  searchAttraction();
  })


// 2-5 塞入Mrt資料，點擊捷運站名稱自動搜尋
fetch("http://54.168.177.59:8000/api/mrts")
.then(function(response){
  return response.json();
})
.then(function(data){
  let mrts = data.data;
  for (i = 0; i < data.data.length; i++){
    let mrt = document.createElement("div");
    mrt.className = "mrts__list_mrt";
    mrt.textContent = mrts[i];

    let mrt_list = document.getElementsByClassName("mrts__list");
    mrt_list[0].appendChild(mrt);
  }

  //點擊捷運站名字，帶入搜尋框，開始搜尋
  let mrt_list = document.querySelectorAll(".mrts__list_mrt"); //幫所有捷運站名都加上事件監聽器
  
  for (var i = 0; i < mrts.length; i++){
    mrt_list[i].addEventListener('click', function() {
      let text = this.textContent;
      let searchinput = document.querySelector(".banner__search_input");
      searchinput.value = text;
      searchAttraction()
    })
  }
})

// 點擊往左箭頭，卷軸向左移動
document.getElementById('left_button').addEventListener('click', function() {
  let container = document.querySelector(".mrts__list");
  container.scrollLeft -= 200;
  })

// 點擊往右箭頭，卷軸向右移動
document.getElementById('right_button').addEventListener('click', function() {
  let container = document.querySelector(".mrts__list");
  container.scrollLeft += 200;
  })


// 以下是chatGPT寫的，幫卷軸加上拖曳移動的功能，
const container = document.querySelector(".mrts__list");

let isDown = false;  // 用來追踪滑鼠或觸摸事件的狀態
let startX;          // 儲存滑鼠按下或觸摸開始時的X座標
let scrollLeft;      // 儲存滑鼠按下或觸摸開始時的滾動位置

container.addEventListener('mousedown', (e) => {
    isDown = true;  // 滑鼠按下，進入拖動狀態
    startX = e.pageX - container.offsetLeft;  // 記錄開始時的X座標
    scrollLeft = container.scrollLeft;  // 記錄開始時的滾動位置
});

container.addEventListener('mouseleave', () => {
    isDown = false;  // 滑鼠移出容器，結束拖動狀態
});

container.addEventListener('mouseup', () => {
    isDown = false;  // 滑鼠釋放，結束拖動狀態
});

container.addEventListener('mousemove', (e) => {
    if (!isDown) return;  // 如果沒有進行拖動操作，直接返回
    e.preventDefault();
    const x = e.pageX - container.offsetLeft;  // 計算當前滑鼠位置
    const walk = (x - startX) * 3;  // 計算滾動距離，3 是滾動速度
    container.scrollLeft = scrollLeft - walk;  // 更新滾動位置
});

// 觸摸事件支持
container.addEventListener('touchstart', (e) => {
    isDown = true;  // 觸摸開始，進入拖動狀態
    startX = e.touches[0].pageX - container.offsetLeft;  // 記錄開始時的X座標
    scrollLeft = container.scrollLeft;  // 記錄開始時的滾動位置
});

container.addEventListener('touchend', () => {
    isDown = false;  // 觸摸結束，結束拖動狀態
});

container.addEventListener('touchmove', (e) => {
    if (!isDown) return;  // 如果沒有進行拖動操作，直接返回
    e.preventDefault();
    const x = e.touches[0].pageX - container.offsetLeft;  // 計算當前觸摸位置
    const walk = (x - startX) * 3;  // 計算滾動距離，3 是滾動速度
    container.scrollLeft = scrollLeft - walk;  // 更新滾動位置
});




</script>
</html>